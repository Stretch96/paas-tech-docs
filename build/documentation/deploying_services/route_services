<h1 id="route-services">Route services</h1><p>Tenants may wish to apply some processing to requests before they reach an application. Common examples of use cases are authentication, rate limiting, and caching services.</p>
<p>If you need to run a private app that can only be accessed by other apps in the same space, you should refer to the documentation on <a href="/deploying_apps.html#deploying-private-apps">private apps</a>.</p>
<p>Cloud Foundry allows the tenants to bind <a href="/deploying_apps.html#names-routes-and-domains">application routes</a> to <a href="https://docs.cloudfoundry.org/services/route-services.html">route services</a>. A route service acts as a full proxy. Once it is bound to a route, the platform routing layer will send every request for that route to the route service endpoint. The route service can then process the incoming request, proxy it back to the original application, and finally process the response request before returning it to the original client.</p>
<p>Using route services has some consequences to be aware of:</p>

<ul>
<li>Every request will include additional latency as it will be proxied through the Routing Service.</li>
<li>The route service will be able to access all the request content in clear.</li>
<li>The route service would become a critical point of failure, and if it is not available, the application will not be available for the end users.</li>
</ul>
<h2 id="user-provided-route-services">User-provided route services</h2><p>Tenants can define their own route service instance by using a <a href="https://docs.cloudfoundry.org/devguide/services/user-provided.html">user-provided service instance</a> that points to any HTTPS service. This endpoint must fulfill the following requirements:</p>

<ul>
<li>It must be a HTTPS endpoint with a valid certificate.</li>
<li>It can be a application running in the platform itself or an external service on the Internet.</li>
<li>It must be reachable from the platform (ie. not blocked by a firewall or in a private network).</li>
<li>It must implement the <a href="/deploying_services/route_services/#implement-a-route-service">route service protocol</a></li>
</ul>
<p>This is how you define an user-provided route service instance and map it to the route of your app:</p>

<ol>
<li><p>From the command line, run:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf create-user-provided-service SERVICE_INSTANCE -r ROUTE_SERVICE_URL
</code></pre></div><p>where <code>SERVICE_INSTANCE</code> is a unique, descriptive name for this route service instance, and <code>ROUTE_SERVICE_URL</code> is the url of the route service endpoint; for example:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf create-user-provided-service my-route-service -r https://route-service.example.org
</code></pre></div><p>The service will be immediately ready to be used, and you can query its status by running:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf service my-route-service
</code></pre></div></li>
<li><p>Bind this route service instance to the <a href="/deploying_apps.html#names-routes-and-domains">application route</a></p>
<div class="highlight"><pre class="highlight plaintext"><code>cf bind-route-service DOMAIN SERVICE_INSTANCE --hostname HOSTNAME
</code></pre></div><p>where:</p>

<ul>
<li><code>DOMAIN</code> is your app domain, and varies depending on which <a href="/orgs_spaces_users.html#regions">region</a> your app is hosted in</li>
<li><code>SERVICE_INSTANCE</code> the name of the service that you have just created</li>
<li><code>HOSTNAME</code> the host or app name assigned to the app</li>
</ul>
<p>For example, if your app is named <code>myapp</code> and is hosted in the London region:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf bind-route-service london.cloudapps.digital my-route-service --hostname myapp
</code></pre></div></li>
<li><p>You can list the <a href="/deploying_apps.html#names-routes-and-domains">routes</a> of the current <a href="/orgs_spaces_users.html#spaces">space</a> to see the applications and route services bound to them:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf routes
</code></pre></div><p>If the route service endpoint is not responding correctly, you might get the following response when querying the route:</p>
<p><code>502 Bad Gateway: Registered endpoint failed to handle the request.</code></p>
<p>If you get this error, double check that the endpoint is working and reachable from the platform, that it is using a valid SSL certificate, that responds timely and that it implements the <a href="/deploying_services/route_services/#implement-a-route-service">route service protocol</a>.</p></li>
</ol>
<h2 id="implement-a-route-service">Implement a route service</h2><p>A route service can be implemented as a HTTPS application that will receive all requests for the associated route from the Cloud Foundry router. The request will contain the following additional headers:</p>

<ul>
<li><code>X-CF-Forwarded-Url</code> header contains the URL of the application route. The route service should forward the request to this URL.</li>
<li><code>X-CF-Proxy-Signature</code> and <code>X-CF-Proxy-Metadata</code>: Signature and metadata used by the platform route itself to validate the request sent by the route service.
The route service must always include these headers.</li>
</ul>
<p>The route service must proxy back the request to the application route defined in header <code>X-CF-Forwarded-Url</code> within 60 seconds, otherwise the request will be refused. In addition, the total time to process the request and send a response back must be within 900 seconds.</p>
<p><a href="/images/route-service.svg" rel="noopener noreferrer"><img src="/images/route-service.svg" alt="Route service request life cycle" /></a></p>
<p>You can refer to the <a href="https://docs.cloudfoundry.org/services/route-services.html">Cloud Foundry documentation on route services</a> for more information.</p>
<h3 id="example-route-service-to-add-username-and-password-authentication">Example: Route service to add username and password authentication</h3><p>In the following example we will add a route service to provide basic HTTP authentication to the bound routes. This can be used to restrict access to a beta application.</p>
<p>An example of such a route service application code can be found in the <a href="https://github.com/alphagov/paas-cf_basic_auth_route_service">Cloud Foundry basic auth route service</a>.
Please note this is a proof-of-concept and is not intended to run in production.</p>
<p>We will deploy it as an app in the platform itself. Then we will bind this route service to an app named <code>myapp</code>, deployed in the London region and therefore accessible at https://myapp.london.cloudapps.digital.</p>

<ol>
<li><p>Deploy the route service as <a href="/deploying_apps.html#deploying-apps">any other other application</a>.
Do not start it yet, as we need to configure it first.</p>
<div class="highlight"><pre class="highlight plaintext"><code>git clone https://github.com/alphagov/paas-cf_basic_auth_route_service
cd paas-cf_basic_auth_route_service
cf push my-basic-auth-service-app --no-start
</code></pre></div><p>Note: You might want to change <code>my-basic-auth-service-app</code> with a different name to avoid conflicts with other tenants&rsquo; apps.</p></li>
<li><p>This example route service can only authenticate one user with fixed username and password. Choose any value for username and password then pass them to the application using environment variables <code>AUTH_USERNAME</code> and <code>AUTH_PASSWORD</code>. Finally the route service can be started:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf set-env my-basic-auth-service-app AUTH_USERNAME myuser
cf set-env my-basic-auth-service-app AUTH_PASSWORD pass1234
cf start my-basic-auth-service-app
</code></pre></div><p>The new service is serving in https://my-basic-auth-service-app.london.cloudapps.digital.</p></li>
<li><p>Register the route service endpoint as an user-provided service instance:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf create-user-provided-service my-basic-auth-service -r https://my-basic-auth-service-app.london.cloudapps.digital
</code></pre></div></li>
<li><p>Finally, bind the route service to the application route:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf bind-route-service london.cloudapps.digital my-basic-auth-service --hostname myapp
</code></pre></div><p>The application in https://myapp.london.cloudapps.digital will now ask for basic HTTP authentication, with login <code>myuser</code> and password <code>pass1234</code>.</p></li>
</ol>
<h3 id="example-route-service-to-add-ip-address-authentication">Example: Route service to add IP address authentication</h3><p>GDS maintains an <a href="https://github.com/alphagov/paas-ip-authentication-route-service">example nginx app</a> which you can use as a route service to add IP address authentication.
This ensures that only HTTP requests originating from a trusted set of IP addresses can access your app.</p>
<p>This example app uses the <code>X-Forwarded-For</code> header added by the GOV.UK PaaS routers to HTTP requests originating from outside the platform.</p>
<p>Using an IP address to authenticate HTTP requests is not sufficient as a standalone authentication mechanism.
You should use other authentication and authorization methods in your apps.</p>
<h4 id="using-the-x-forwarded-for-header">Using the <code>X-Forwarded-For</code> header</h4><p>The <code>X-Forwarded-For</code> header is useful for working out the source IP address of the originating HTTP request, and can be used for authentication, or analytics.</p>
<p>The GOV.UK PaaS routers set headers in the following format: <code>X-Forwarded-For: SOURCE-IP-ADDRESSES, ROUTER-INTERNAL-IP-ADDRESS</code>, where:</p>

<ul>
<li><code>SOURCE-IP-ADDRESSES</code> are the source IP addresses of the original request</li>
<li><code>ROUTER-INTERNAL-IP-ADDRESS</code> is the internal IP address of the router handling the request</li>
</ul>
<p>For example: <code>X-Forwarded-For: 208.80.152.201, 10.0.0.49</code></p>
<p>If you are using the <code>X-Forwarded-For</code> header for IP address authentication, then you should trust the CIDR range <code>10.0.0.0/8</code> to set the <code>X-Forwarded-For</code> header.</p>
<h4 id="proxied-requests">Proxied requests</h4><p>If the <code>X-Forwarded-For</code> header is already set when the router receives the request, then the router appends the source IP address of the request and router&rsquo;s IP address to the header.</p>
<p>For example:</p>

<ul>
<li>an HTTP request sent from <code>208.80.152.201</code> to the router has the header <code>X-Forwarded-For: 1.2.3.4</code></li>
<li>the router loopback IP address is <code>127.0.0.1</code></li>
<li>the router internal IP address is <code>10.0.0.49</code></li>
</ul>
<p>The <code>X-Forwarded-For</code> header presented to your app will be: <code>X-Forwarded-For: 1.2.3.4, 208.80.152.201, 10.0.0.49</code></p>
