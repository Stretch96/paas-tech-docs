<h1 id="elasticsearch">Elasticsearch</h1><p><a href="https://www.elastic.co/">Elasticsearch</a> is an open source full-text RESTful search and analytics engine that allows you to store and search data.</p>
<p>Before using Elasticsearch as your primary data store, you should assess if an <a href="https://www.techopedia.com/definition/23949/atomicity-consistency-isolation-durability-acid">ACID-compliant</a> backing service such as <a href="/deploying_services/postgresql/#postgresql">PostgreSQL</a> or <a href="/deploying_services/mysql/#mysql">MySQL</a> would better meet your needs.</p>

<h2 id="set-up-the-service">Set up the service</h2>
<h3 id="set-up-an-elasticsearch-service">Set up an Elasticsearch service</h3>
<ol>
<li><p>Run the following in the command line to see what plans are available for Elasticsearch:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf marketplace -s elasticsearch
</code></pre></div><p>Here is an example of the output you will see:</p>
<div class="highlight"><pre class="highlight plaintext"><code>service plan   description                                                          free or paid
small-ha-7.x   3 dedicated VMs, 1 CPU per VM, 4GB RAM per VM, 240GB disk space.     paid
large-ha-7.x   3 dedicated VMs, 2 CPU per VM, 15GB RAM per VM, 1050GB disk space.   paid
</code></pre></div><p>The following table explains the syntax in this output:</p>

<div style="height:1px;font-size:1px;">&nbsp;</div>
<div class="table-container">
        <table>
          <tr>
<th style="text-align: left">Syntax</th>
<th style="text-align: left">Meaning</th>
</tr>
<tr>
<td style="text-align: left"><code>ha</code></td>
<td style="text-align: left">High availability</td>
</tr>
<tr>
<td style="text-align: left"><code>X.X</code></td>
<td style="text-align: left">Version number</td>
</tr>
<tr>
<td style="text-align: left"><code>small</code></td>
<td style="text-align: left">Size of instance</td>
</tr>

        </table>
      </div>
<div style="height:1px;font-size:1px;">&nbsp;</div>
<p>All high availability (<code>ha</code>) plans are suitable for production.</p>
<p>You should check the size of the available plans against your service needs.</p></li>
<li><p>Run the following to create a service instance:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf create-service elasticsearch PLAN SERVICE_NAME
</code></pre></div><p>where <code>PLAN</code> is the plan you want, and <code>SERVICE_NAME</code> is a unique descriptive name for this service instance. For example:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf create-service elasticsearch small-ha-7.x my-es-service
</code></pre></div><p>It will take between 5 and 10 minutes to set up the service instance. To check its progress, run:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf service SERVICE_NAME
</code></pre></div><p>for example:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf service my-es-service
</code></pre></div><p>When <code>cf service SERVICE_NAME</code> returns a <code>create succeeded</code> status, you have set up the service instance. An example output could be:</p>
<div class="highlight"><pre class="highlight plaintext"><code>name:            my-es-service
service:         elasticsearch
tags:
plan:            small-ha-7.x
description:     Elasticsearch instances provisioned via Aiven
documentation:
dashboard:

There are no bound apps for this service.

Showing status of last operation from service my-es-service...

status:    create succeeded
message:   Last operation succeeded
started:   2018-08-02T10:17:30Z
updated:   2018-08-02T10:21:35Z
</code></pre></div></li>
</ol>
<h3 id="bind-an-elasticsearch-service-to-your-apps">Bind an Elasticsearch service to your apps</h3><p>To access the cache from the app, you must bind your app to the Elasticsearch service.</p>

<ol>
<li><p>Use the <a href="/deploying_apps.html#deploying-public-apps">app&rsquo;s manifest</a> to bind the app to the service instance. It will bind automatically when you next deploy your app. An example manifest:</p>
<div class="highlight"><pre class="highlight plaintext"><code>--
applications:
  - name: my-app
    services:
    - my-es-service
</code></pre></div></li>
<li><p>Deploy your app in line with your normal deployment process.</p></li>
</ol>
<p>This binds your app to a service instance called <code>my-es-service</code>.</p>
<p>Refer to the <a href="https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#services-block">Cloud Foundry documentation on deploying with app manifests</a> for more information.</p>
<h4 id="use-the-cf-bind-service-command">Use the cf bind-service command</h4><p>Alternatively, you can manually bind your service instance to your app.</p>

<ol>
<li><p>Run the following:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf bind-service APP_NAME SERVICE_NAME
</code></pre></div><p>where <code>APP_NAME</code> is the exact name of a deployed instance of your application and <code>SERVICE_NAME</code> is the name of the service instance you created. For example:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf bind-service my-app my-es-service
</code></pre></div></li>
<li><p>Deploy your app in line with your normal deployment process.</p></li>
</ol>
<p>Refer to the <a href="https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#services-block">Cloud Foundry documentation on deploying with app manifests</a> for more information.</p>

<h2 id="amend-the-service">Amend the service</h2>
<h3 id="upgrade-elasticsearch-service-plan">Upgrade Elasticsearch service plan</h3><p>You can upgrade your plan using the <code>cf update-service</code> command. Run the following in the command line:</p>
<div class="highlight"><pre class="highlight shell"><code>cf update-service SERVICE_NAME <span class="nt">-p</span> NEW_PLAN_NAME
</code></pre></div><p>where <code>SERVICE_NAME</code> is a unique descriptive name for this service instance, and <code>NEW_PLAN_NAME</code> is the name of your new plan. For example:</p>
<div class="highlight"><pre class="highlight shell"><code>cf update-service my-elasticsearch-service <span class="nt">-p</span> small-ha-7.x
</code></pre></div><p>The plan upgrade will start immediately and finish within an hour. You can check the status of the upgrade by running <code>cf services</code>.</p>

<h2 id="remove-the-service">Remove the service</h2>
<h3 id="unbind-an-elasticsearch-service-from-your-app">Unbind an Elasticsearch service from your app</h3><p>You must unbind the Elasticsearch service before you can delete it. Run the following in the command line:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf unbind-service APP_NAME SERVICE_NAME
</code></pre></div><p>where <code>APP_NAME</code> is your app&rsquo;s deployed instance name as specified in your app&rsquo;s <code>manifest.yml</code> or push command, and <code>SERVICE_NAME</code> is a unique descriptive name for this service instance, for example:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf unbind-service my-app my-es-service
</code></pre></div><p>If you unbind your services from your app but do not delete them, the services will persist even after you have deleted your app, and you can re-bind or re-connect to them in future.</p>
<h3 id="delete-an-elasticsearch-service">Delete an Elasticsearch service</h3><p>Once you have unbound the Elasticsearch service from your app, you can delete the service. Run the following in the command line:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf delete-service SERVICE_NAME
</code></pre></div><p>where <code>SERVICE_NAME</code> is a unique descriptive name for this service instance. For example:</p>
<div class="highlight"><pre class="highlight plaintext"><code>cf delete-service my-es-service
</code></pre></div><p>Enter <code>yes</code> when asked for confirmation.</p>

<h2 id="maintaining-the-service">Maintaining the service</h2>
<h3 id="data-classification">Data classification</h3><p>You can store data classified up to Official on the GOV.UK PaaS. Refer to the <a href="/deploying_services/#data-security-classification">data security classification documentation</a> for more information.</p>
<h3 id="elasticsearch-backups">Elasticsearch backups</h3><p>Aiven automatically backs up all data stored within any Elasticsearch service you create.</p>
<p>Backups are taken every 2 hours. Data is retained for:</p>

<ul>
<li>2 days if you have a <code>tiny</code> plan</li>
<li>14 days if you have a <code>small</code>, <code>medium</code> or <code>large</code> plan</li>
</ul>
<p>To restore data to an earlier state, you can visit the <a href="https://admin.london.cloud.service.gov.uk/support">GOV.UK PaaS support page</a> or contact us at <a href="mailto:gov-uk-paas-support@digital.cabinet-office.gov.uk">gov-uk-paas-support@digital.cabinet-office.gov.uk</a>.</p>
<h3 id="view-your-elasticsearch-data-using-kibana">View your Elasticsearch data using Kibana</h3><p>Aiven provide a Kibana user interface through which you can explore the data in your Elasticsearch. You can access Kibana using the following instructions:</p>

<ol>
<li><p>Run the following to get some valid credentials for your Elasticsearch:</p>
<div class="highlight"><pre class="highlight shell"><code>cf create-service-key NAME_OF_YOUR_ELASTICSEARCH creds-for-kibana

cf service-key NAME_OF_YOUR_ELASTICSEARCH creds-for-kibana
</code></pre></div><p>That outputs a hostname, username and password that you will use later.</p></li>
<li><p>Set up an SSH tunnel to your target Elasticsearch:</p>
<div class="highlight"><pre class="highlight shell"><code>cf ssh <span class="nt">-L</span> 4430:HOSTNAME_FROM_STEP_1:443 NAME_OF_AN_APP_YOU_CAN_SSH_TO
</code></pre></div><p>Elasticsearch instances are only accessible from the PaaS. This sets up a tunnel so that you can get access, similar to how we use <a href="https://github.com/alphagov/paas-cf-conduit">Conduit</a> elsewhere.</p></li>
<li><p>Access Kibana via your browser by going to <a href="https://localhost:4430">https://localhost:4430</a>.
When prompted for credentials, provide the username and password from step 1.
If you see a blank page then make sure your browser url is using <code>https</code> and not <code>http</code>.</p></li>
<li><p>To clean up when you are done, <code>CTRL+C</code> the <code>cf ssh</code> session from step 2 and run <code>cf delete-service-key NAME_OF_YOUR_ELASTICSEARCH creds-for-kibana</code>.</p></li>
</ol>
<h3 id="further-information">Further information</h3><p>Refer to the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch documentation</a> for more information.</p>
