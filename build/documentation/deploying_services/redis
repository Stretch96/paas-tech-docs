<h1 id="redis">Redis</h1>

<p>Redis is an open source in-memory data store that can be used as a database cache or message broker.</p>

<p>You can access <a href="/monitoring_services.html">metrics for this backing service</a>.</p>

<h2 id="set-up-the-service">Set up the service</h2>

<h3 id="set-up-a-redis-service">Set up a Redis service</h3>

<p>To set up a Redis service:</p>

<ol>
  <li>
<p>Run the following in the command line to see what service plans are available for Redis:</p>

<div class="highlight"><pre class="highlight plaintext"><code> cf marketplace -s redis
</code></pre></div>
<p>Here is an example of the output you will see (the exact service plans will vary):</p>

<div class="highlight"><pre class="highlight plaintext"><code> service plan         description                                                                                        free or paid
 tiny-3.2             568MB RAM, single node, no failover, daily backups (for instances created after 21/1/2019)         free
 tiny-ha-3.2          1.5GB RAM, highly-available, daily backups                                                         paid
 small-ha-3.2         3GB RAM, highly-available, daily backups                                                           paid
 medium-ha-3.2        6.37GB RAM, highly-available, daily backups                                                        paid
</code></pre></div>
<p>Refer to the <a href="/deploying_services/redis/#redis-service-plans">Redis service plans</a> section of the documentation for more information.</p>

<p>Do not use the <code>tiny-clustered-3.2</code> service plan for new service instances as we have deprecated this plan.</p>
  </li>
  <li>
<p>Run the following to create a service instance:</p>

<div class="highlight"><pre class="highlight plaintext"><code> cf create-service redis PLAN SERVICE_NAME
</code></pre></div>
<p>where <code>PLAN</code> is the service plan you want, and <code>SERVICE_NAME</code> is a unique descriptive name for this service instance. For example:</p>

<div class="highlight"><pre class="highlight plaintext"><code> cf create-service redis tiny-3.2 my-redis-service
</code></pre></div>  </li>
  <li>
<p>It will take between 5 and 10 minutes to set up the service instance. To check its progress, run:</p>

<div class="highlight"><pre class="highlight plaintext"><code> cf service SERVICE_NAME
</code></pre></div>
<p>for example:</p>

<div class="highlight"><pre class="highlight plaintext"><code> cf service my-redis-service
</code></pre></div>
<p>When <code>cf service SERVICE_NAME</code> returns a <code>create succeeded</code> status, you have set up the service instance. Example output:</p>

<div class="highlight"><pre class="highlight plaintext"><code> name:            my-redis-service
 service:         redis
 bound apps:
 tags:
 plan:            tiny-3.2
 description:     AWS ElastiCache Redis service
 documentation:
 dashboard:

 Showing status of last operation from service my-redis-service...

 status:    create succeeded
 message:   ---
            status               : available
            cluster id           : cf-u7zpvbwzxmrvu
            engine version       : 3.2.6
            maxmemory policy     : volatile-lru
            maintenance window   : sun:23:00-mon:01:30
            daily backup window  : 02:00-05:00
 started:   2018-02-21T10:44:16Z
 updated:   2018-02-21T10:52:31Z

</code></pre></div>  </li>
</ol>

<h3 id="bind-a-redis-service-to-your-app">Bind a Redis service to your app</h3>

<p>You must bind your app to the Redis service so you can access the cache from the app.</p>

<ol>
  <li>
<p>Use the <a href="/deploying_apps.html#deploying-public-apps">app's manifest</a> to bind the app to the service instance. It will bind automatically when you next deploy your app. An example manifest:</p>

<div class="highlight"><pre class="highlight plaintext"><code> --
 applications:
   - name: my-app
     services:
     - my-redis-service
</code></pre></div>  </li>
  <li>
<p>Deploy your app in line with your normal deployment process.</p>
  </li>
</ol>

<p>This binds your app to a service instance called <code>my-redis-service</code>.</p>

<p>Refer to the <a href="https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#services-block">Cloud Foundry documentation on deploying with app manifests</a> for more information.</p>

<h4 id="use-the-cf-bind-service-command">Use the cf bind-service command</h4>

<p>Alternatively, you can manually bind your service instance to your app.</p>

<ol>
  <li>
<p>Run the following:</p>

<div class="highlight"><pre class="highlight plaintext"><code> cf bind-service APP_NAME SERVICE_NAME
</code></pre></div>
<p>where <code>APP_NAME</code> is the exact name of a deployed instance of your application and <code>SERVICE_NAME</code> is the name of the service instance you created. For example:</p>

<div class="highlight"><pre class="highlight plaintext"><code> cf bind-service my-app my-redis-service
</code></pre></div>  </li>
  <li>
<p>Deploy your app in line with your normal deployment process.</p>
  </li>
</ol>

<h3 id="connect-to-a-redis-service-from-your-app">Connect to a Redis service from your app</h3>

<p>Your app must make a <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a> connection to the service. Some libraries use TLS by default, but others will need to be manually configured.</p>

<p>Your app should parse the <code>VCAP_SERVICES</code> <a href="/deploying_apps.html#system-provided-environment-variables">environment variable</a> to make a secure connection to Redis.</p>

<p>If your app writes database connection errors to <code>STDOUT</code> or <code>STDERR</code>, you can view recent errors with <code>cf logs APP_NAME --recent</code>. See the section on <a href="/monitoring_apps.html#logs">logs</a> for details.</p>

<h3 id="connect-to-a-redis-service-instance-from-your-local-machine">Connect to a Redis service instance from your local machine</h3>

<p>We have created the <a href="/guidance.html#conduit">Conduit</a> plugin to simplify the process of connecting your local machine to a Redis service.</p>

<h4 id="prerequisites">Prerequisites</h4>

<p>You must:</p>

<ul>
  <li><p>install the Redis CLI tool on your local machine (this is included in the <a href="https://redis.io/download">standard Redis installation</a>)</p>
  </li>
  <li><p><a href="/get_started.html#set-up-command-line">log into Cloud Foundry</a></p>
  </li>
  <li><p><a href="/deploying_apps.html#set-a-target">target the space</a> where your Redis service instance is located</p>
  </li>
</ul>

<h4 id="install-and-configure-conduit">Install and configure Conduit</h4>

<ol>
  <li>
<p>Run the following command to install the Conduit plugin:</p>

<div class="highlight"><pre class="highlight plaintext"><code> cf install-plugin conduit
</code></pre></div>  </li>
  <li>
<p>Run the following command to connect to your service instance with the Redis client:</p>

<div class="highlight"><pre class="highlight plaintext"><code> $ cf conduit SERVICE_NAME -- redis-cli
</code></pre></div>
<p>where <code>SERVICE_NAME</code> is a unique descriptive name for this service instance.</p>
  </li>
</ol>

<p>You have now connected your local machine to your Redis service instance using Conduit. You can test this connection with the Redis <a href="https://redis.io/commands/ping">PING command</a>:</p>

<div class="highlight"><pre class="highlight plaintext"><code>127.0.0.1:7081&gt; PING
PONG
</code></pre></div>
<p>Run <code>cf conduit --help</code> for more options, and refer to the <a href="https://github.com/alphagov/paas-cf-conduit/blob/master/README.md">Conduit README file</a> for more information on how to use the plugin.</p>

<h2 id="amend-the-service">Amend the service</h2>

<h3 id="upgrade-redis-service-plan">Upgrade Redis service plan</h3>

<p>You can upgrade your plan using the <code>cf update-service</code> command. Run the following in the command line:</p>

<div class="highlight"><pre class="highlight plaintext"><code>cf update-service SERVICE_NAME -p NEW_PLAN_NAME
</code></pre></div>
<p>where <code>SERVICE_NAME</code> is a unique descriptive name for this service instance, and <code>NEW_PLAN_NAME</code> is the name of your new plan. For example:</p>

<div class="highlight"><pre class="highlight plaintext"><code>cf update-service my-redis-service -p medium-ha-3.2
</code></pre></div>
<p>The plan upgrade will start immediately and finish within an hour. You can check the status of the upgrade by running <code>cf services</code>.</p>

<h2 id="remove-the-service">Remove the service</h2>

<h3 id="unbind-a-redis-service-from-your-app">Unbind a Redis service from your app</h3>

<p>You must unbind the Redis service before you can delete your service instance. To unbind the Redis service, run the following code in the command line:</p>

<div class="highlight"><pre class="highlight plaintext"><code>cf unbind-service APPLICATION SERVICE_NAME
</code></pre></div>
<p>where <code>APPLICATION</code> is the name of a deployed instance of your application (exactly as specified in your app's <code>manifest.yml</code> file or push command) and <code>SERVICE_NAME</code> is a unique descriptive name for this service instance, for example:</p>

<div class="highlight"><pre class="highlight plaintext"><code>cf unbind-service my-app my-redis-service
</code></pre></div>
<p>If you unbind your services from your app but do not delete them, these services will persist even after your app is deleted. You can re-bind or reconnect to them in future.</p>

<h3 id="delete-a-redis-service">Delete a Redis service</h3>

<p>Once the Redis service has been unbound from your app, you can delete your service instance. Run the following in the command line:</p>

<div class="highlight"><pre class="highlight plaintext"><code>cf delete-service SERVICE_NAME
</code></pre></div>
<p>where <code>SERVICE_NAME</code> is a unique descriptive name for this service instance.</p>

<p>Type <code>yes</code> when asked for confirmation.</p>

<h2 id="maintaining-the-service">Maintaining the service</h2>

<h3 id="data-classification">Data classification</h3>

<p>You can store data classified up to ‘official’ on the GOV.UK PaaS. Refer to the <a href="/deploying_services/#data-security-classification">data security classification documentation</a> for more information.</p>

<h3 id="redis-service-plans">Redis service plans</h3>

<p>Each service in the marketplace has multiple plans that vary by availability and storage capacity.</p>

<h4 id="paid-plans---redis">Paid plans - Redis</h4>

<p>Some service plans are paid and we will bill you based on your service usage.</p>

<p>New organisations cannot access paid plans by default. Enabling this access is controlled by an organisation's <a href="/#quotas">quota</a> settings.</p>

<p>If paid plans are not enabled, when you try to use a paid service you will receive an error stating “service instance cannot be created because paid service plans are not allowed”. One of your <a href="/orgs_spaces_users.html#org-manager">org managers</a> must contact us at <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#103;&#111;&#118;&#045;&#117;&#107;&#045;&#112;&#097;&#097;&#115;&#045;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#064;&#100;&#105;&#103;&#105;&#116;&#097;&#108;&#046;&#099;&#097;&#098;&#105;&#110;&#101;&#116;&#045;&#111;&#102;&#102;&#105;&#099;&#101;&#046;&#103;&#111;&#118;&#046;&#117;&#107;">&#103;&#111;&#118;&#045;&#117;&#107;&#045;&#112;&#097;&#097;&#115;&#045;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#064;&#100;&#105;&#103;&#105;&#116;&#097;&#108;&#046;&#099;&#097;&#098;&#105;&#110;&#101;&#116;&#045;&#111;&#102;&#102;&#105;&#099;&#101;&#046;&#103;&#111;&#118;&#046;&#117;&#107;</a> to request that we enable paid services.</p>

<h4 id="high-availability-plans---redis">High availability plans - Redis</h4>

<p>If you use a high availability service plan, Amazon ElastiCache for Redis provides a hot standby service for <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/AutoFailover.html">failover</a>.</p>

<p>If you do not have a high availability service plan, you will lose data during a service instance failure. Before deciding which service plan to use, you should assess your data and what type of plan you need.</p>

<h3 id="redis-maintenance--backups">Redis maintenance &amp; backups</h3>

<h4 id="redis-maintenance-times">Redis maintenance times</h4>

<p>Every Redis service has a maintenance window of Sunday 11pm to Monday 1:30am UTC every week. Contact us at <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#103;&#111;&#118;&#045;&#117;&#107;&#045;&#112;&#097;&#097;&#115;&#045;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#064;&#100;&#105;&#103;&#105;&#116;&#097;&#108;&#046;&#099;&#097;&#098;&#105;&#110;&#101;&#116;&#045;&#111;&#102;&#102;&#105;&#099;&#101;&#046;&#103;&#111;&#118;&#046;&#117;&#107;">&#103;&#111;&#118;&#045;&#117;&#107;&#045;&#112;&#097;&#097;&#115;&#045;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#064;&#100;&#105;&#103;&#105;&#116;&#097;&#108;&#046;&#099;&#097;&#098;&#105;&#110;&#101;&#116;&#045;&#111;&#102;&#102;&#105;&#099;&#101;&#046;&#103;&#111;&#118;&#046;&#117;&#107;</a> if you require a different maintenance window.</p>

<p>For more information on maintenance times, refer to the <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/VersionManagement.MaintenanceWindow.html">Amazon ElastiCache maintenance window documentation</a>.</p>

<h4 id="redis-service-backup">Redis service backup</h4>

<p>All service plans are backed up every day.</p>

<p>The data stored within any Redis service instance you create is backed up using the Amazon ElastiCache backup system. Backups are taken every day between 2am and 5am UTC. Data is retained for 7 days, and stored in <a href="https://aws.amazon.com/s3/">Amazon S3</a>.</p>

<p>To restore from the latest backup of your Redis service instance, create a new service instance by running the following code:</p>

<div class="highlight"><pre class="highlight plaintext"><code>cf create-service redis PLAN NEW_SERVICE_NAME -c '{ "restore_from_latest_snapshot_of": "GUID" }'
</code></pre></div>
<p>where <code>PLAN</code> is the name of the service plan, <code>NEW_SERVICE_NAME</code> is the name of your new service instance, and <code>GUID</code> is the UUID of the pre-existing backed-up instance. Get the <code>GUID</code> by running <code>cf service --guid SERVICE_NAME</code>.</p>

<p>To restore from an older backup, contact us at <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#103;&#111;&#118;&#045;&#117;&#107;&#045;&#112;&#097;&#097;&#115;&#045;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#064;&#100;&#105;&#103;&#105;&#116;&#097;&#108;&#046;&#099;&#097;&#098;&#105;&#110;&#101;&#116;&#045;&#111;&#102;&#102;&#105;&#099;&#101;&#046;&#103;&#111;&#118;&#046;&#117;&#107;">&#103;&#111;&#118;&#045;&#117;&#107;&#045;&#112;&#097;&#097;&#115;&#045;&#115;&#117;&#112;&#112;&#111;&#114;&#116;&#064;&#100;&#105;&#103;&#105;&#116;&#097;&#108;&#046;&#099;&#097;&#098;&#105;&#110;&#101;&#116;&#045;&#111;&#102;&#102;&#105;&#099;&#101;&#046;&#103;&#111;&#118;&#046;&#117;&#107;</a>.</p>

<p>For more details about how the backup system works, see the <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/backups-automatic.html">Amazon's ElastiCache backups documentation</a>.</p>

<h3 id="redis-key-eviction-policy">Redis key eviction policy</h3>

<p>The eviction policy is the behaviour Redis follows when you reach your service plan's maximum memory limit. The eviction policy can take the following values:</p>

<div style="height:1px;font-size:1px;">&nbsp;</div>

<div class="table-container">
        <table>
  <thead>
    <tr>
      <th style="text-align: left">Eviction policy</th>
      <th style="text-align: left">Definition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code>volatile-lru</code></td>
      <td style="text-align: left">evict keys by trying to remove the least recently used (LRU) keys first, but only among keys that have an expire set, in order to make space for the new data added</td>
    </tr>
    <tr>
      <td style="text-align: left"><code>allkeys-lru</code></td>
      <td style="text-align: left">evict keys by trying to remove the least recently used (LRU) keys first, in order to make space for the new data added</td>
    </tr>
    <tr>
      <td style="text-align: left"><code>allkeys-random</code></td>
      <td style="text-align: left">evict keys randomly in order to make space for the new data added</td>
    </tr>
    <tr>
      <td style="text-align: left"><code>volatile-random</code></td>
      <td style="text-align: left">evict keys randomly in order to make space for the new data added, but only evict keys with an expire set</td>
    </tr>
    <tr>
      <td style="text-align: left"><code>volatile-ttl</code></td>
      <td style="text-align: left">evict keys with an expire set, and try to evict keys with a shorter time to live (TTL) first, in order to make space for the new data added</td>
    </tr>
    <tr>
      <td style="text-align: left"><code>noeviction</code></td>
      <td style="text-align: left">return errors when the memory limit was reached and the client is trying to execute commands that could result in more memory to be used</td>
    </tr>
  </tbody>
</table>

      </div>
<div style="height:1px;font-size:1px;">&nbsp;</div>

<p>Your Redis instance is set to use the <code>volatile-lru</code> eviction policy by default. You can check this by running the <code>cf service SERVICE_NAME</code> command.</p>

<p>You can set the eviction policy for an existing service instance by running:</p>

<div class="highlight"><pre class="highlight plaintext"><code>cf update-service SERVICE_NAME -c '{"maxmemory_policy": "EVICTION_POLICY"}'
</code></pre></div>
<p>where <code>SERVICE_NAME</code> is a unique descriptive name for this service instance and <code>EVICTION_POLICY</code> is the eviction policy you want, for example:</p>

<div class="highlight"><pre class="highlight plaintext"><code>cf update-service my-redis-service -c '{"maxmemory_policy": "volatile-ttl"}'
</code></pre></div>
<p>Refer to the <a href="https://redis.io/topics/lru-cache">Redis LRU cache documentation</a> for more information.</p>

<h3 id="further-information">Further information</h3>

<p>Refer to the <a href="https://aws.amazon.com/elasticache/redis/">Amazon ElastiCache for Redis page</a> [external link] for more information.</p>
